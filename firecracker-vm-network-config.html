<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Firecracker VM Network Config</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <h1 class="title">Firecracker VM Network Config</h1>
  <div class="updated">updated: 10.01.2026</div>

  <div class="content">

    <h2>firecracker-vm-network-config</h2>

    <p>
      This document explains how to set up <strong>host-side networking</strong> for a Firecracker microVM.
      The goal is to give the microVM <strong>basic networking + internet access</strong> using a TAP device and NAT.
    </p>

    <p>This setup is meant to be <strong>simple</strong>, <strong>reusable</strong>, and <strong>easy to understand</strong>.</p>

    <h3>What This Setup Does</h3>

    <p>On the <strong>host machine</strong>, we:</p>

    <ol>
      <li>Create a <strong>TAP device</strong></li>
      <li>Assign an IP address to the TAP device</li>
      <li>Enable <strong>IPv4 forwarding</strong></li>
      <li>Add <strong>NAT rules</strong> for internet access</li>
    </ol>

    <blockquote>
      <strong>NOTE:</strong> Run this script <strong>before starting Firecracker</strong>.
    </blockquote>

    <h3>Basic Terminology</h3>

    <h4>TAP Device</h4>
    <p>
      A <strong>TAP device</strong> is a kernel-created virtual network interface operating at
      <strong>Layer 2 (Data Link Layer)</strong>.
      It behaves like a virtual Ethernet card whose packets can be handled by a userspace program (Firecracker here).
    </p>

    <h4>NAT (Network Address Translation)</h4>
    <p>
      NAT rewrites IP addresses so multiple devices can share one public IP.
      This allows the microVM to use the host's internet access.
    </p>

    <h3>Host Network Setup Script</h3>

    <p><strong>File:</strong> <code>host-network-config.sh</code></p>

    <pre><code class="language-bash">
#!/bin/bash
# ============================================
# Firecracker Networking Setup (HOST SIDE)
# ============================================
# This script:
# 1. Creates TAP device
# 2. Assigns IP to TAP
# 3. Enables IP forwarding
# 4. Adds NAT rules for internet access
#
# Run this ON THE HOST before starting Firecracker
# ============================================

set -e

# Configuation (TAP dev, IP can be changed as needed)
TAP_DEV="tap0"
HOST_TAP_IP="172.16.0.1/24"
VM_SUBNET="172.16.0.0/24"

# Detect default internet interface automatically
WAN_IFACE=$(ip route | awk '/default/ {print $5}')

echo "[+] Using WAN interface: $WAN_IFACE"

# 1. Create TAP device
echo "[+] Creating TAP device: $TAP_DEV"
sudo ip tuntap add $TAP_DEV mode tap || true
sudo ip addr add $HOST_TAP_IP dev $TAP_DEV || true
sudo ip link set $TAP_DEV up

# 2. Enable IP forwarding
echo "[+] Enabling IPv4 forwarding"
sudo sysctl -w net.ipv4.ip_forward=1

# 3. NAT rules (iptables)
echo "[+] Adding NAT rules"

sudo iptables -t nat -A POSTROUTING -s $VM_SUBNET -o $WAN_IFACE -j MASQUERADE
sudo iptables -A FORWARD -i $WAN_IFACE -o $TAP_DEV -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i $TAP_DEV -o $WAN_IFACE -j ACCEPT

echo "[✓] Network setup complete"
echo "[✓] Now we are ready to start Firecracker"
    </code></pre>

    <h3>Result</h3>

    <ul>
      <li>The host has a <strong>TAP interface</strong></li>
      <li>IP forwarding is enabled</li>
      <li>VM traffic is <strong>NATed</strong> through the host</li>
      <li>Firecracker microVMs can access the internet</li>
    </ul>

    <h3>VM Network Setup</h3>
    <p><strong>File:</strong> <code>vm-net-config.sh</code></p>

    <pre><code class="language-bash">
#!/bin/bash
# ============================================
# Firecracker VM Network Setup (VM SIDE)
# ============================================

set -e

# Configuration files in VM
VM_IP="172.16.0.2/24"
GATEWAY="172.16.0.1"
IFACE="eth0"

ip addr add $VM_IP dev $IFACE || true
ip link set $IFACE up
ip route add default via $GATEWAY || true

# DNS
echo "nameserver 8.8.8.8" > /etc/resolv.conf

echo "[✓] VM network configured"
    </code></pre>

  </div>

  <div style="margin-top: 40px;">
    <a href="blogs.html">← Back to Blogs</a>
  </div>

</body>
</html>
